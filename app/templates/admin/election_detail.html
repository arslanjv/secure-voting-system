{% extends "base.html" %}

{% block title %}{{ election.title }} - Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">{{ election.title }}</h4>
                    <div>
                        {% if election.status.value == 'draft' %}
                        <span class="badge bg-secondary">Draft</span>
                        {% elif election.status.value == 'active' %}
                        <span class="badge bg-success">Active</span>
                        {% elif election.status.value == 'closed' %}
                        <span class="badge bg-warning text-dark">Closed</span>
                        {% elif election.status.value == 'tallied' %}
                        <span class="badge bg-info">Tallied</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <h5>Election Details</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th width="30%">Description:</th>
                                <td>{{ election.description }}</td>
                            </tr>
                            <tr>
                                <th>Start Time:</th>
                                <td>{{ election.start_time.strftime('%Y-%m-%d %H:%M:%S UTC') }}</td>
                            </tr>
                            <tr>
                                <th>End Time:</th>
                                <td>{{ election.end_time.strftime('%Y-%m-%d %H:%M:%S UTC') }}</td>
                            </tr>
                            <tr>
                                <th>Max Selections:</th>
                                <td>{{ election.max_selections }} candidate(s)</td>
                            </tr>
                            <tr>
                                <th>Allow Multiple Votes:</th>
                                <td>{{ 'Yes' if election.allow_multiple_votes else 'No' }}</td>
                            </tr>
                            <tr>
                                <th>Created At:</th>
                                <td>{{ election.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h5>Candidates ({{ election.candidates.count() }})</h5>
                {% if election.candidates.count() > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for candidate in election.candidates %}
                            <tr>
                                <td><strong>{{ candidate.name }}</strong></td>
                                <td>{{ candidate.description or 'N/A' }}</td>
                                <td>
                                    {% if election.status.value == 'draft' %}
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('admin.edit_candidate', candidate_id=candidate.id) }}"
                                            class="btn btn-outline-warning">
                                            <i class="bi bi-pencil"></i> Edit
                                        </a>
                                        <form method="POST"
                                            action="{{ url_for('admin.delete_candidate', candidate_id=candidate.id) }}"
                                            class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-outline-danger"
                                                onclick="return confirm('Delete this candidate?')">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </form>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">Locked</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    No candidates added yet. Add candidates before activating the election.
                </div>
                {% endif %}

                {% if election.status.value == 'draft' %}
                <div class="d-grid gap-2 mt-3">
                    <a href="{{ url_for('admin.add_candidate', election_id=election.id) }}" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Add Candidate
                    </a>
                </div>
                {% endif %}

                <h5 class="mt-4">Voting Statistics</h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-light text-center">
                            <div class="card-body">
                                <h3 class="mb-0">{{ election.votes.count() }}</h3>
                                <small class="text-muted">Total Votes Cast</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light text-center">
                            <div class="card-body">
                                <h3 class="mb-0">{{ election.candidates.count() }}</h3>
                                <small class="text-muted">Candidates</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light text-center">
                            <div class="card-body">
                                <h3 class="mb-0">{{ election.status.value.title() }}</h3>
                                <small class="text-muted">Current Status</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <a href="{{ url_for('admin.list_elections') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Elections
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0"><i class="bi bi-gear"></i> Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if election.status.value == 'draft' %}
                    <a href="{{ url_for('admin.edit_election', election_id=election.id) }}" class="btn btn-warning">
                        <i class="bi bi-pencil"></i> Edit Election
                    </a>
                    <form method="POST" action="{{ url_for('admin.activate_election', election_id=election.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-success w-100"
                            onclick="return confirm('Activate this election? This will open voting and lock election parameters.')">
                            <i class="bi bi-play-circle"></i> Activate Election
                        </button>
                    </form>
                    {% if vote_count == 0 %}
                    <form method="POST" action="{{ url_for('admin.delete_election', election_id=election.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger w-100"
                            onclick="return confirm('Are you sure you want to delete this election? This action cannot be undone.')">
                            <i class="bi bi-trash"></i> Delete Election
                        </button>
                    </form>
                    {% endif %}
                    {% elif election.status.value == 'active' %}
                    <form method="POST" action="{{ url_for('admin.close_election', election_id=election.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-warning w-100"
                            onclick="return confirm('Close this election? This will stop accepting votes.')">
                            <i class="bi bi-stop-circle"></i> Close Election
                        </button>
                    </form>
                    {% elif election.status.value == 'closed' %}
                    <a href="{{ url_for('admin.tally_election', election_id=election.id) }}" class="btn btn-info">
                        <i class="bi bi-calculator"></i> Tally Votes
                    </a>
                    {% elif election.status.value == 'tallied' %}
                    <a href="{{ url_for('admin.view_results', election_id=election.id) }}" class="btn btn-primary">
                        <i class="bi bi-bar-chart"></i> View Results
                    </a>
                    <a href="{{ url_for('admin.export_results', election_id=election.id) }}" class="btn btn-success">
                        <i class="bi bi-download"></i> Export Results
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card mt-3 bg-light">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-shield-lock"></i> Security Info</h6>
            </div>
            <div class="card-body">
                <p class="small mb-2"><strong>Encryption:</strong></p>
                <p class="small mb-3">
                    {% if election.keypair %}
                    <span class="badge bg-success">RSA-4096 + AES-256-GCM Active</span>
                    {% else %}
                    <span class="badge bg-warning text-dark">Not Generated</span>
                    {% endif %}
                </p>

                <p class="small mb-2"><strong>Digital Signatures:</strong></p>
                <p class="small mb-0">
                    {% if election.signature_public_key %}
                    <span class="badge bg-success">Ed25519 Active</span>
                    {% else %}
                    <span class="badge bg-warning text-dark">Not Generated</span>
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Status Workflow</h6>
            </div>
            <div class="card-body">
                <ol class="small mb-0">
                    <li><strong>Draft:</strong> Configure election & add candidates</li>
                    <li><strong>Activate:</strong> Open voting to voters</li>
                    <li><strong>Close:</strong> Stop accepting votes</li>
                    <li><strong>Tally:</strong> Decrypt & count votes</li>
                    <li><strong>Results:</strong> Publish final results</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}